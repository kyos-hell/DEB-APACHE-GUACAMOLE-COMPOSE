Step 1 : Installer les dépendance / Librairie
apt update
apt install -y \
libcairo2-dev libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
freerdp2-dev libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev \
libwebsockets-dev libpulse-dev libssl-dev libvorbis-dev libwebp-dev \
libjpeg62-turbo-dev openjdk-17-jdk libpng-dev libtool-bin uuid-dev \
libossp-uuid-dev build-essential autoconf automake libtool pkg-config openjdk-17-jdk



Step 2 : Télécharger et installer le binaire de guacamole serveur
wget -O guacamole-server-1.6.0.tar.gz "https://apache.org/dyn/closer.lua/guacamole/1.6.0/source/guacamole-server-1.6.0.tar.gz?action=download"
tar -xzf guacamole-server-1.6.0.tar.gz
rm guacamole-server-1.6.0.tar.gz
cd guacamole-server-1.6.0/
./configure --with-systemd-dir=/usr/local/lib/systemd/system
make
make install

# Vérifier ldconfig
echo $PATH  # doit inclure /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ldconfig

Step 3 : Configuration guacamole client et tomcat9

#configuration tomcat9
useradd -r -d /opt/tomcat9 -s /bin/false tomcat
mkdir /opt/tomcat9
wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.111/bin/apache-tomcat-9.0.111.tar.gz
tar xzf apache-tomcat-9.0.111.tar.gz -C /opt/tomcat9 --strip-components=1
chown -R tomcat: /opt/tomcat9/{logs,temp,webapps,work}
chown -R :tomcat /opt/tomcat9/
chmod -R g+r /opt/tomcat9/conf
chmod g+x /opt/tomcat9/conf
echo 'export CATALINA_HOME="/opt/tomcat9"' > /etc/profile.d/tomcat9.sh
update-java-alternatives -l
echo 'export JAVA_HOME="/usr/lib/jvm/java-1.17.0-openjdk-amd64"' >> /etc/profile.d/tomcat9.sh
source /etc/profile.d/tomcat9.sh
chown -R tomcat:tomcat /opt/tomcat9
systemctl enable --now tomcat9
systemctl status tomcat9
systemctl restart tomcat9.service
systemctl status tomcat9


# Télécharger et installer le binaire de guacamole client
wget -O guacamole-1.6.0.war "https://apache.org/dyn/closer.lua/guacamole/1.6.0/binary/guacamole-1.6.0.war?action=download"
cp guacamole-1.6.0.war /opt/tomcat9/webapps/guacamole.war
chown tomcat:tomcat /opt/tomcat9/webapps/guacamole.war
mkdir -p /etc/guacamole
echo -e "guacd-hostname: localhost\nguacd-port: 4822" > /etc/guacamole/guacamole.properties
chmod 700 /etc/guacamole
chmod 600 /etc/guacamole/guacamole.properties

step 4 Crée le fichier de conf tomcat 
cat > /etc/systemd/system/tomcat9.service <<EOF
[Unit]
Description=Apache Tomcat 9 Web Application Container
After=network.target

[Service]
Type=forking
User=tomcat
Group=tomcat

Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
Environment="CATALINA_PID=/opt/tomcat9/temp/tomcat.pid"
Environment="CATALINA_HOME=/opt/tomcat9"
Environment="CATALINA_BASE=/opt/tomcat9"
Environment="CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC"

ExecStart=/opt/tomcat9/bin/startup.sh
ExecStop=/opt/tomcat9/bin/shutdown.sh

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable tomcat9
systemctl start tomcat9
systemctl status tomcat9


Etape 5 : Installation de mysql + configuration
apt install -y mariadb-server mariadb-client libmariadb-java

# Télécharger le driver JDBC pour Guacamole
cd /tmp
wget -O guacamole-auth-jdbc-1.6.0.tar.gz "https://apache.org/dyn/closer.lua/guacamole/1.6.0/binary/guacamole-auth-jdbc-1.6.0.tar.gz?action=download"
tar xzf guacamole-auth-jdbc-1.6.0.tar.gz

# Configuration MariaDB
mysql -u root

# Création de la DB
CREATE DATABASE guacamole_db;

# Création de l'utilisateur guacamole
CREATE USER 'guacamole_user' IDENTIFIED BY 'some_password';
GRANT SELECT,INSERT,UPDATE,DELETE ON guacamole_db.* TO 'guacamole_user';
FLUSH PRIVILEGES;

#Charger les schema
cat /tmp/guacamole-auth-jdbc-1.6.0/mysql/schema/*.sql | mysql -u root guacamole_db

# Modifier la conf guacamole_properties
cat > /etc/guacamole/guacamole.properties <<EOF
# Guacamole <-> guacd
guacd-hostname: localhost
guacd-port: 4822
guacd-hostname: ::1

# Authentification MySQL
mysql-hostname: localhost
mysql-port: 3306
mysql-database: guacamole_db
mysql-username: guacamole_user
mysql-password: some_password
mysql-driver: mariadb
mysql-ssl-mode: disabled

# Répertoires Guacamole
lib-directory: /etc/guacamole/lib
auth-provider: net.sourceforge.guacamole.net.auth.mysql.MySQLAuthenticationProvider
EOF

# Vérification des services 
systemctl restart tomcat9
systemctl restart guacd

# Vérification des logs 
tail -n 50 /opt/tomcat9/logs/catalina.out

Test CI
















