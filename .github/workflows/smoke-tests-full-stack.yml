name: Smoke tests — full stack (guacd + mariadb + guacamole)

on:
  workflow_call:
    inputs:
      tag:
        description: 'CI tag suffix (commit SHA) to test (e.g. github.sha). If empty, workflow will fallback to github.sha.'
        required: true
        type: string

permissions:
  contents: read
  packages: read

jobs:
  smoke-guacd:
    name: Smoke guacd (pull ci tag — fail if missing)
    runs-on: ubuntu-latest
    env:
      TAG: ${{ inputs.tag != '' && inputs.tag || github.sha }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull guacd CI image (with fallback to latest)
        run: |
          set -euo pipefail
          CI_IMG="ghcr.io/${{ github.repository_owner }}/guacd:ci-${TAG}"
          LATEST_IMG="ghcr.io/${{ github.repository_owner }}/guacd:latest"
          echo "Attempting docker pull $CI_IMG with retry"
          pulled=0
          for i in $(seq 1 12); do
            if docker pull "$CI_IMG"; then
              echo "Pulled $CI_IMG on attempt $i"
              SELECTED="$CI_IMG"
              pulled=1
              break
            fi
            echo "Not available yet, retrying in 10s... ($i/12)"
            sleep 10
          done
          if [ "$pulled" -eq 0 ]; then
            echo "CI image not found, attempting to pull latest: $LATEST_IMG"
            if docker pull "$LATEST_IMG"; then
              SELECTED="$LATEST_IMG"
            else
              echo "ERROR: Neither CI nor latest image available: $CI_IMG / $LATEST_IMG"
              exit 1
            fi
          fi
          echo "GUACD_IMAGE=$SELECTED" >> $GITHUB_ENV

      - name: Run guacd container
        run: docker run -d --name smoke-guacd "$GUACD_IMAGE"

      - name: Wait and verify process
        run: |
          set -euo pipefail
          sleep 5
          if docker ps --filter "name=smoke-guacd" --format "{{.Names}}" | grep -q "^smoke-guacd$"; then
            echo "guacd container running"
          else
            echo "guacd container not running"
            docker logs smoke-guacd || true
            exit 1
          fi

      - name: Check port 4822 listening
        run: |
          set -euo pipefail
          docker exec smoke-guacd sh -c '
            if command -v ss >/dev/null 2>&1; then
              ss -ltn | grep -q ":4822 "
            elif command -v netstat >/dev/null 2>&1; then
              netstat -ltn | grep -q ":4822"
            else
              echo "No ss/netstat available"; exit 0
            fi
          ' || { echo 'Port 4822 not listening'; docker logs smoke-guacd || true; exit 1; }

      - name: Cleanup guacd
        if: always()
        run: docker rm -f smoke-guacd || true

  smoke-mariadb:
    name: Smoke mariadb (pull ci tag — fail if missing)
    runs-on: ubuntu-latest
    env:
      TAG: ${{ inputs.tag != '' && inputs.tag || github.sha }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull mariadb CI image (with fallback to latest)
        run: |
          set -euo pipefail
          CI_IMG="ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-${TAG}"
          LATEST_IMG="ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:latest"
          echo "Attempting docker pull $CI_IMG with retry"
          pulled=0
          for i in $(seq 1 12); do
            if docker pull "$CI_IMG"; then
              echo "Pulled $CI_IMG on attempt $i"
              SELECTED="$CI_IMG"
              pulled=1
              break
            fi
            echo "Not available yet, retrying in 10s... ($i/12)"
            sleep 10
          done
          if [ "$pulled" -eq 0 ]; then
            echo "CI image not found, attempting to pull latest: $LATEST_IMG"
            if docker pull "$LATEST_IMG"; then
              SELECTED="$LATEST_IMG"
            else
              echo "ERROR: Neither CI nor latest image available: $CI_IMG / $LATEST_IMG"
              exit 1
            fi
          fi
          echo "MARIADB_IMAGE=$SELECTED" >> $GITHUB_ENV

      - name: Run MariaDB container
        run: |
          docker run -d --name smoke-mariadb --network bridge \
            -e MYSQL_ROOT_PASSWORD=rootpassword \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            "$MARIADB_IMAGE"

      - name: Wait for MariaDB readiness
        run: |
          set -euo pipefail
          for i in $(seq 1 40); do
            if docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1; then
              echo "MariaDB ready at attempt $i"
              break
            fi
            echo "Waiting MariaDB... ($i)"
            sleep 2
          done
          docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; docker logs smoke-mariadb || true; exit 1; }

      - name: Cleanup mariadb
        if: always()
        run: docker rm -f smoke-mariadb || true

  smoke-guacamole:
    name: Smoke Guacamole stack (depends on guacd + mariadb)
    runs-on: ubuntu-latest
    needs: [smoke-guacd, smoke-mariadb]
    env:
      TAG: ${{ inputs.tag != '' && inputs.tag || github.sha }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull images (CI tag -> fallback to :latest)
        run: |
          set -euo pipefail
          for img in guacamole guacd mariadb-guacamole; do
            CI_FULL="ghcr.io/${{ github.repository_owner }}/${img}:ci-${TAG}"
            LATEST_FULL="ghcr.io/${{ github.repository_owner }}/${img}:latest"
            echo "Attempting docker pull $CI_FULL with retry"
            pulled=0
            for i in $(seq 1 12); do
              if docker pull "$CI_FULL"; then
                echo "Pulled $CI_FULL on attempt $i"
                SELECTED="$CI_FULL"
                pulled=1
                break
              fi
              echo "Not available yet, retrying in 10s... ($i/12)"
              sleep 10
            done
            if [ "$pulled" -eq 0 ]; then
              echo "CI image not found for $img, attempting latest: $LATEST_FULL"
              if docker pull "$LATEST_FULL"; then
                SELECTED="$LATEST_FULL"
              else
                echo "ERROR: No suitable image for $img (neither CI nor latest found)"
                exit 1
              fi
            fi
            case "$img" in
              guacd)
                echo "GUACD_IMAGE=$SELECTED" >> $GITHUB_ENV
                ;;
              mariadb-guacamole)
                echo "MARIADB_IMAGE=$SELECTED" >> $GITHUB_ENV
                ;;
              guacamole)
                echo "GUACAMOLE_IMAGE=$SELECTED" >> $GITHUB_ENV
                ;;
            esac
          done

      - name: Create network (idempotent)
        run: docker network inspect guacnet >/dev/null 2>&1 || docker network create guacnet

      - name: Start MariaDB + guacd (support)
        run: |
          docker run -d --name smoke-mariadb --network guacnet \
            -e MYSQL_ROOT_PASSWORD=rootpassword \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            "$MARIADB_IMAGE"
          docker run -d --name smoke-guacd --network guacnet "$GUACD_IMAGE"

      - name: Start Guacamole container
        run: |
          docker run -d --name smoke-guac --network guacnet -p 8080:8080 \
            -e GUACD_HOST=smoke-guacd \
            -e MYSQL_HOST=smoke-mariadb \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            "$GUACAMOLE_IMAGE"

      - name: Wait for Guacamole HTTP (context path)
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1; then
              echo "HTTP context /guacamole/ ready at attempt $i"
              break
            fi
            echo "Waiting Guacamole... ($i)"
            sleep 2
          done
          curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1 || { echo "Guacamole not responding"; docker logs smoke-guac || true; exit 1; }

      - name: Check schema presence and attempt login (optional)
        run: |
          set -euo pipefail
          if docker exec smoke-mariadb mysql -uroot -prootpassword -e "USE guacamole_db; SHOW TABLES LIKE 'guacamole_user';" | grep -q guacamole_user; then
            echo "Schema present, attempting login..."
            for i in $(seq 1 10); do
              resp=$(curl -sS -H 'Content-Type: application/x-www-form-urlencoded' -X POST http://localhost:8080/guacamole/api/tokens --data 'username=guacadmin&password=guacadmin' || true)
              echo "Try $i -> $resp"
              echo "$resp" | grep -q '"authToken"' && { echo "login ok"; break; }
              sleep 2
            done
          else
            echo "Schema not present, skipping login test"
          fi

      - name: Dump logs on failure
        if: ${{ failure() }}
        run: |
          docker logs smoke-guac || true
          docker logs smoke-mariadb || true
          docker logs smoke-guacd || true

      - name: Cleanup
        if: always()
        run: |
          docker rm -f smoke-guac smoke-mariadb smoke-guacd || true
          docker network rm guacnet || true