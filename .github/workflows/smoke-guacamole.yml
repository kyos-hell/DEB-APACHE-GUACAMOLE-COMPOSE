# Full smoke for Guacamole stack: builds local images, creates network, runs containers,
# checks schema and optionally logs in (if schema present).
on:
  push:
    paths:
      - "guacamole-tomcat/**"
      - "mariadb-guacamole/**"
      - "guacd/**"
    branches: ["dev"]
  pull_request:
    paths:
      - "guacamole-tomcat/**"
      - "mariadb-guacamole/**"
      - "guacd/**"
    branches: ["dev"]
  workflow_dispatch: {}

jobs:
  smoke-guacamole:
    name: Smoke test Guacamole (HTTP + DB + optional login)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build local images
        run: |
          docker build -t mariadb-guacamole:ci ./mariadb-guacamole
          docker build -t guacd:ci ./guacd
          docker build -t guacamole:ci ./guacamole-tomcat

      - name: Create network (idempotent)
        run: |
          docker network inspect guacnet >/dev/null 2>&1 || docker network create guacnet
          docker network ls

      - name: Start MariaDB + guacd (support)
        run: |
          docker run -d --name mariadb-guacamole --network guacnet -e MYSQL_ROOT_PASSWORD=rootpassword -e MYSQL_DATABASE=guacamole_db -e MYSQL_USER=guacamole_user -e MYSQL_PASSWORD=some_password mariadb-guacamole:ci
          docker run -d --name guacd --network guacnet guacd:ci
          docker ps --format '{{.Names}} -> {{.Status}}'

      - name: Wait for MariaDB readiness
        run: |
          for i in $(seq 1 40); do
            docker exec mariadb-guacamole mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 && break || true
            echo "Waiting MariaDB... ($i)"
            sleep 2
          done
          docker exec mariadb-guacamole mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; docker logs mariadb-guacamole; exit 1; }

      - name: (Optional) Import Guacamole schema if present in repo (safe no-op)
        run: |
          if [ -f ./guacamole-tomcat/sql/guacamole-schema-mysql.sql ]; then
            echo "Importing schema from repo..."
            docker cp ./guacamole-tomcat/sql/guacamole-schema-mysql.sql mariadb-guacamole:/tmp/guac-schema.sql
            docker exec mariadb-guacamole sh -c "mysql -uroot -prootpassword guacamole_db < /tmp/guac-schema.sql"
          else
            echo "No local schema found, skipping import."
          fi

      - name: Start Guacamole container
        run: |
          docker run -d --name smoke-guac --network guacnet -p 8080:8080 \
            -e GUACD_HOST=guacd \
            -e MYSQL_HOST=mariadb-guacamole \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            guacamole:ci
          sleep 3
          echo "guacamole.properties inside container:"
          docker exec smoke-guac sh -c "cat /etc/guacamole/guacamole.properties 2>/dev/null || cat /opt/guacamole/guacamole.properties 2>/dev/null || echo 'No properties'"

      - name: Wait for Guacamole HTTP (context path)
        run: |
          for i in $(seq 1 60); do
            if curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1; then
              echo "HTTP context /guacamole/ ready at attempt $i"
              break
            fi
            echo "Waiting Guacamole... ($i)"
            sleep 2
          done
          curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1 || { echo "Guacamole not responding"; docker logs smoke-guac; exit 1; }
          echo "Guacamole HTTP reachable"

      - name: Wait for JDBC extension log (non-blocking)
        run: |
          for i in $(seq 1 30); do
            docker logs smoke-guac 2>&1 | grep -q 'MySQL Authentication' && { echo "JDBC extension log detected"; break; }
            echo "Waiting JDBC extension log... ($i)"
            sleep 2
          done

      - name: Check if schema present (guacamole_user)
        id: schema
        run: |
          if docker exec mariadb-guacamole mysql -uroot -prootpassword -e "USE guacamole_db; SHOW TABLES LIKE 'guacamole_user';" | grep -q guacamole_user; then
            echo "has_schema=true" >> $GITHUB_OUTPUT
            echo "Schema presence detected"
          else
            echo "has_schema=false" >> $GITHUB_OUTPUT
            echo "Schema NOT detected"
          fi

      - name: Attempt login (guacadmin) with retries (only if schema present)
        if: ${{ steps.schema.outputs.has_schema == 'true' }}
        run: |
          set -euo pipefail
          LOGIN_OK=0
          for i in $(seq 1 15); do
            resp=$(curl -sS -H 'Content-Type: application/x-www-form-urlencoded' -X POST http://localhost:8080/guacamole/api/tokens --data 'username=guacadmin&password=guacadmin' || true)
            echo "Try $i -> $resp"
            echo "$resp" | grep -q '"authToken"' && { LOGIN_OK=1; break; }
            sleep 2
          done
          if [ "$LOGIN_OK" -eq 1 ]; then
            echo "Login token obtained"
          else
            echo "Login failed after retries"
            docker logs smoke-guac | tail -n 200 || true
            exit 1
          fi

      - name: Extra debug (always)
        if: always()
        run: |
          echo "--- Extensions dir ---"
          docker exec smoke-guac sh -c "ls -1 /opt/guacamole/extensions" 2>/dev/null || echo "No /opt/guacamole/extensions"
          echo "--- guacamole.properties ---"
          docker exec smoke-guac sh -c "cat /etc/guacamole/guacamole.properties" 2>/dev/null || \
            docker exec smoke-guac sh -c "cat /opt/guacamole/guacamole.properties" 2>/dev/null || echo "No properties file"
          echo "--- MariaDB tables (first 40) ---"
          docker exec mariadb-guacamole mysql -uroot -prootpassword -e "USE guacamole_db; SHOW TABLES;" 2>/dev/null || echo "Cannot list tables"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f smoke-guac mariadb-guacamole guacd || true
          docker network rm guacnet || true
