# Smoke Test guacd — rebuilds image locally and checks process + port 4822
on:
  push:
    paths:
      - "guacd/**"
    branches: ["dev"]
  pull_request:
    paths:
      - "guacd/**"
    branches: ["dev"]
  workflow_dispatch: {}

jobs:
  smoke-guacd:
    name: Smoke test guacd (port 4822 + process)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build local guacd image
        run: docker build -t guacd:ci ./guacd

      - name: Run guacd container
        run: docker run -d --name smoke-guacd guacd:ci

      - name: Wait and verify process
        run: |
          sleep 5
          docker ps --filter "name=smoke-guacd" --format "{{.Names}}" | grep -q smoke-guacd \
            && echo "guacd container running" \
            || (echo "guacd container not running" && docker logs smoke-guacd && exit 1)

      - name: Install net-tools inside container (if apt available)
        run: |
          docker exec smoke-guacd sh -c 'if command -v apt-get >/dev/null 2>&1; then DEBIAN_FRONTEND=noninteractive apt-get update >/dev/null && apt-get install -y --no-install-recommends net-tools >/dev/null || true; else echo "apt-get not available"; fi'

      - name: Check port 4822 listening
        run: |
          docker exec smoke-guacd sh -c "netstat -ltn | grep -q ':4822' && echo 'Port 4822 listening' || (echo 'Port 4822 not listening ❌'; docker logs smoke-guacd; exit 1)"

      - name: Logs on failure
        if: ${{ failure() }}
        run: docker logs smoke-guacd || true

      - name: Cleanup
        if: always()
        run: docker rm -f smoke-guacd || true
