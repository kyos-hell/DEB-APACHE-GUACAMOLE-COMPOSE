name: Smoke tests — full stack (guacd + mariadb + guacamole)

permissions:
  contents: read
  packages: read

on:
  workflow_run:
    workflows: ["Build Guacamole Stack images (CI tag)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional: ci tag suffix (commit SHA). If empty, uses workflow_run.head_sha'
        required: false
        default: ''

jobs:
  smoke-guacd:
    name: Smoke guacd (pull ci tag — fail if missing)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine TAG to use
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag || '' }}" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            echo "TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          fi
          echo "Using TAG=${TAG}"

      - name: Pull guacd CI image (must exist)
        run: |
          set -euo pipefail
          IMG="ghcr.io/${{ github.repository_owner }}/guacd:ci-${TAG}"
          echo "Attempting docker pull $IMG"
          if ! docker pull "$IMG"; then
            echo "ERROR: CI image not found: $IMG"
            exit 1
          fi

      - name: Run guacd container
        run: docker run -d --name smoke-guacd ghcr.io/${{ github.repository_owner }}/guacd:ci-${TAG}

      - name: Wait and verify process
        run: |
          sleep 5
          docker ps --filter "name=smoke-guacd" --format "{{.Names}}" | grep -q smoke-guacd \
            && echo "guacd container running" \
            || (echo "guacd container not running" && docker logs smoke-guacd && exit 1)

      - name: Check port 4822 listening
        run: |
          docker exec smoke-guacd sh -c "if command -v netstat >/dev/null 2>&1; then netstat -ltn | grep -q ':4822' && echo 'Port 4822 listening' || (echo 'Port 4822 not listening'; docker logs smoke-guacd; exit 1); else echo 'netstat not available'; fi"

      - name: Cleanup guacd
        if: always()
        run: docker rm -f smoke-guacd || true

  smoke-mariadb:
    name: Smoke mariadb (pull ci tag — fail if missing)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine TAG to use
        id: tag2
        run: |
          if [ -n "${{ github.event.inputs.tag || '' }}" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            echo "TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          fi
          echo "Using TAG=${TAG}"

      - name: Pull mariadb CI image (must exist)
        run: |
          set -euo pipefail
          IMG="ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-${TAG}"
          echo "Attempting docker pull $IMG"
          if ! docker pull "$IMG"; then
            echo "ERROR: CI image not found: $IMG"
            exit 1
          fi

      - name: Run MariaDB container
        run: |
          docker run -d --name smoke-mariadb --network bridge \
            -e MYSQL_ROOT_PASSWORD=rootpassword \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-${TAG}

      - name: Wait for MariaDB readiness
        run: |
          for i in $(seq 1 40); do
            docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 && break || true
            echo "Waiting MariaDB... ($i)"
            sleep 2
          done
          docker exec smoke-mariadb mysqladmin ping -uroot -prootpassword --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; docker logs smoke-mariadb; exit 1; }

      - name: Cleanup mariadb
        if: always()
        run: docker rm -f smoke-mariadb || true

  smoke-guacamole:
    name: Smoke Guacamole stack (depends on guacd + mariadb)
    runs-on: ubuntu-latest
    needs: [smoke-guacd, smoke-mariadb]
    if: ${{ (needs.smoke-guacd.result == 'success') && (needs.smoke-mariadb.result == 'success') }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine TAG to use
        run: |
          if [ -n "${{ github.event.inputs.tag || '' }}" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            echo "TAG=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          fi
          echo "Using TAG=${TAG}"

      - name: Pull images (must exist)
        run: |
          TAG=${TAG}
          for img in guacamole guacd mariadb-guacamole; do
            FULL="ghcr.io/${{ github.repository_owner }}/${img}:ci-${TAG}"
            echo "Pulling $FULL"
            if ! docker pull "$FULL"; then
              echo "ERROR: CI image not found: $FULL"
              exit 1
            fi
          done

      - name: Create network (idempotent)
        run: docker network inspect guacnet >/dev/null 2>&1 || docker network create guacnet

      - name: Start MariaDB + guacd (support)
        run: |
          TAG=${TAG}
          docker run -d --name smoke-mariadb --network guacnet \
            -e MYSQL_ROOT_PASSWORD=rootpassword \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-${TAG}
          docker run -d --name smoke-guacd --network guacnet ghcr.io/${{ github.repository_owner }}/guacd:ci-${TAG}

      - name: Start Guacamole container
        run: |
          TAG=${TAG}
          docker run -d --name smoke-guac --network guacnet -p 8080:8080 \
            -e GUACD_HOST=smoke-guacd \
            -e MYSQL_HOST=smoke-mariadb \
            -e MYSQL_DATABASE=guacamole_db \
            -e MYSQL_USER=guacamole_user \
            -e MYSQL_PASSWORD=some_password \
            ghcr.io/${{ github.repository_owner }}/guacamole:ci-${TAG}

      - name: Wait for Guacamole HTTP (context path)
        run: |
          for i in $(seq 1 60); do
            if curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1; then
              echo "HTTP context /guacamole/ ready at attempt $i"
              break
            fi
            echo "Waiting Guacamole... ($i)"
            sleep 2
          done
          curl -sS -f http://localhost:8080/guacamole/ >/dev/null 2>&1 || { echo "Guacamole not responding"; docker logs smoke-guac; exit 1; }

      - name: Check schema presence and attempt login (optional)
        run: |
          if docker exec smoke-mariadb mysql -uroot -prootpassword -e "USE guacamole_db; SHOW TABLES LIKE 'guacamole_user';" | grep -q guacamole_user; then
            echo "Schema present, attempting login..."
            for i in $(seq 1 10); do
              resp=$(curl -sS -H 'Content-Type: application/x-www-form-urlencoded' -X POST http://localhost:8080/guacamole/api/tokens --data 'username=guacadmin&password=guacadmin' || true)
              echo "Try $i -> $resp"
              echo "$resp" | grep -q '"authToken"' && { echo "login ok"; break; }
              sleep 2
            done
          else
            echo "Schema not present, skipping login test"
          fi

      - name: Dump logs on failure
        if: ${{ failure() }}
        run: |
          docker logs smoke-guac || true
          docker logs smoke-mariadb || true
          docker logs smoke-guacd || true

      - name: Cleanup
        if: always()
        run: |
          docker rm -f smoke-guac smoke-mariadb smoke-guacd || true
          docker network rm guacnet || true