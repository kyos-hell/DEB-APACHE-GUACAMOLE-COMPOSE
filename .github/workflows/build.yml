name: Build Guacamole Stack images (CI tag)

on:
  push:
    branches: ["dev", "main"]
  pull_request:
    branches: ["dev", "main"]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  ###########################################
  # JOB 1 — Build MariaDB image (CI tag)
  ###########################################
  build-mariadb:
    name: Build MariaDB image (:ci)
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths (paths-filter)
        id: pf
        uses: dorny/paths-filter@v2
        with:
          filters: |
            mariadb:
              - 'mariadb-guacamole/**'

      - name: Skip if no changes in mariadb
        if: ${{ steps.pf.outputs.mariadb == 'false' }}
        run: |
          echo "No changes in mariadb-guacamole — skipping build."
          exit 0

      - name: Decide push or load (avoid pushing for forked PRs)
        id: mode
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "push=true" >> $GITHUB_OUTPUT
          else
            # If PR is from same repo, allow push; otherwise do not push
            if [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
              echo "push=true" >> $GITHUB_OUTPUT
            else
              echo "push=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (when push)
        if: ${{ steps.mode.outputs.push == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push/load mariadb image (ci tag)
        uses: docker/build-push-action@v6
        with:
          context: ./mariadb-guacamole
          file: ./mariadb-guacamole/Dockerfile
          push: ${{ steps.mode.outputs.push == 'true' }}
          load: ${{ steps.mode.outputs.push == 'false' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/mariadb-guacamole:ci-${{ github.sha }}

      - name: Show local images
        run: docker images

  ###########################################
  # JOB 2 — Build GUACD image (CI tag)
  ###########################################
  build-guacd:
    name: Build GUACD image (:ci)
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths (paths-filter)
        id: pf2
        uses: dorny/paths-filter@v2
        with:
          filters: |
            guacd:
              - 'guacd/**'

      - name: Skip if no changes in guacd
        if: ${{ steps.pf2.outputs.guacd == 'false' }}
        run: |
          echo "No changes in guacd — skipping build."
          exit 0

      - name: Decide push or load (avoid pushing for forked PRs)
        id: mode2
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "push=true" >> $GITHUB_OUTPUT
          else
            if [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
              echo "push=true" >> $GITHUB_OUTPUT
            else
              echo "push=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (when push)
        if: ${{ steps.mode2.outputs.push == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push/load guacd image (ci tag)
        uses: docker/build-push-action@v6
        with:
          context: ./guacd
          file: ./guacd/Dockerfile
          push: ${{ steps.mode2.outputs.push == 'true' }}
          load: ${{ steps.mode2.outputs.push == 'false' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/guacd:ci-${{ github.sha }}

      - name: Show local images
        run: docker images

  ###########################################
  # JOB 3 — Build Guacamole Web (Tomcat) (CI tag)
  ###########################################
  build-guacamole:
    name: Build Guacamole image (:ci)
    runs-on: ubuntu-latest
    needs: build-guacd
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths (paths-filter)
        id: pf3
        uses: dorny/paths-filter@v2
        with:
          filters: |
            guacamole:
              - 'guacamole-tomcat/**'

      - name: Skip if no changes in guacamole-tomcat
        if: ${{ steps.pf3.outputs.guacamole == 'false' }}
        run: |
          echo "No changes in guacamole-tomcat — skipping build."
          exit 0

      - name: Decide push or load (avoid pushing for forked PRs)
        id: mode3
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "push=true" >> $GITHUB_OUTPUT
          else
            if [ "${{ github.event.pull_request.head.repo.full_name }}" = "${{ github.repository }}" ]; then
              echo "push=true" >> $GITHUB_OUTPUT
            else
              echo "push=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (when push)
        if: ${{ steps.mode3.outputs.push == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push/load guacamole image (ci tag)
        uses: docker/build-push-action@v6
        with:
          context: ./guacamole-tomcat
          file: ./guacamole-tomcat/Dockerfile
          push: ${{ steps.mode3.outputs.push == 'true' }}
          load: ${{ steps.mode3.outputs.push == 'false' }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/guacamole:ci-${{ github.sha }}

      - name: Show local images
        run: docker images
  ###########################################
  # JOB 4 — Run smoke tests after images are built and pushed
  ###########################################
  smoke-tests:
    name: Run smoke tests (reusable workflow)
    needs: [build-mariadb, build-guacd, build-guacamole]
    # Ne lance les tests que sur la branche dev, et évite les PRs venant de forks (pas de push d’images)
    if: github.ref == 'refs/heads/dev' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
    uses: kyos-hell/DEB-APACHE-GUACAMOLE-COMPOSE/.github/workflows/smoke-tests-full-stack.yml@dev
    with:
      tag: ${{ github.sha }}
    secrets: inherit