name: Build Guacamole Stack images

on:
  push:
    branches: ["dev", "main"]
  pull_request:
    branches: ["dev", "main"]

jobs:
  ###########################################
  # JOB 1 — Build MariaDB image
  ###########################################
  build-mariadb:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes in mariadb-guacamole
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^mariadb-guacamole/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Show result
        run: |
          echo "Changes detected: ${{ steps.changes.outputs.changes }}"

      - name: Setup Docker Buildx
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (only on main)
        if: ${{ steps.changes.outputs.changes == 'true' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build mariadb image (push only on main)
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./mariadb-guacamole
          file: ./mariadb-guacamole/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' }}
          load: ${{ github.ref != 'refs/heads/main' }}
          tags: ghcr.io/${{ github.actor }}/mariadb-guacamole:latest

      - run: docker images

  ###########################################
  # JOB 1b — Smoke Test MariaDB (DB existence)
  ###########################################
  test-mariadb-smoke:
    name: Smoke test mariadb (guacamole_db existence)
    runs-on: ubuntu-latest
    needs: build-mariadb
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Detect changes in mariadb-guacamole
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^mariadb-guacamole/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if no changes
        if: ${{ steps.changes.outputs.changes == 'false' }}
        run: |
          echo "No changes in mariadb-guacamole, skipping smoke test."
          exit 0

      - name: Run MariaDB container (MYSQL_DATABASE=guacamole_db)
        run: |
          IMAGE="ghcr.io/${{ github.actor }}/mariadb-guacamole:latest"
          docker run -d --name smoke-mariadb -e MYSQL_DATABASE=guacamole_db "$IMAGE"

      - name: Wait for MariaDB readiness
        run: |
          for i in $(seq 1 40); do
            docker exec smoke-mariadb mysqladmin ping -uroot --silent >/dev/null 2>&1 && break
            echo "Waiting for MariaDB... ($i)"
            sleep 2
          done
          docker exec smoke-mariadb mysqladmin ping -uroot --silent >/dev/null 2>&1 || { echo "MariaDB not ready"; exit 1; }

      - name: Check guacamole_db existence
        run: |
          docker exec smoke-mariadb mysql -uroot -e "SHOW DATABASES LIKE 'guacamole_db';" | grep -q guacamole_db \
            && echo "Database guacamole_db exists" \
            || (echo "Database guacamole_db NOT found" && docker logs smoke-mariadb && exit 1)

      - name: List databases (debug)
        if: ${{ success() }}
        run: docker exec smoke-mariadb mysql -uroot -e "SHOW DATABASES;"

      - name: Dump MariaDB logs (on failure)
        if: ${{ failure() }}
        run: docker logs smoke-mariadb || true

      - name: Cleanup
        if: always()
        run: |
          docker stop smoke-mariadb || true
          docker rm smoke-mariadb || true
  ###########################################
  # JOB 2 — Build GUACD image
  ###########################################
  build-guacd:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes in guacd
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^guacd/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Show result
        run: |
          echo "Changes detected: ${{ steps.changes.outputs.changes }}"

      - name: Setup Docker Buildx
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (only on main)
        if: ${{ steps.changes.outputs.changes == 'true' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build guacd image (push only on main)
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./guacd
          file: ./guacd/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ghcr.io/${{ github.actor }}/guacd:latest

      - run: docker images

  ###########################################
  # JOB 2b — Smoke Test guacd (port 4822 & process)
  ###########################################
  test-guacd-smoke:
    name: Smoke test guacd (port 4822 + process)
    runs-on: ubuntu-latest
    needs: build-guacd
    if: ${{ github.ref != 'refs/heads/main' }}
    steps:
      - name: Detect changes in guacd
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^guacd/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Skip if no changes
        if: ${{ steps.changes.outputs.changes == 'false' }}
        run: |
          echo "No changes in guacd — skipping smoke test."
          exit 0
      - name: Run guacd container
        run: |
          IMAGE="ghcr.io/${{ github.actor }}/guacd:latest"
          docker run -d --name smoke-guacd "$IMAGE"
      - name: Wait and verify process
        run: |
          sleep 5
          docker ps --filter "name=smoke-guacd" --format "{{.Names}}" | grep -q smoke-guacd \
            && echo "guacd container running" \
            || (echo "guacd container not running" && docker logs smoke-guacd && exit 1)
      - name: Check port 4822 listening
        run: |
          docker exec smoke-guacd sh -c "apk add --no-cache net-tools 2>/dev/null || true"
          docker exec smoke-guacd sh -c "ss -lnt | grep -q ':4822' && echo 'Port 4822 listening' || (echo 'Port 4822 not listening'; exit 1)"
          # Alternative externe (sur le host du runner) :
          # docker exec smoke-guacd sh -c "nc -z localhost 4822" ...
      - name: Logs on failure
        if: ${{ failure() }}
        run: docker logs smoke-guacd || true
      - name: Cleanup
        if: always()
        run: |
          docker stop smoke-guacd || true
          docker rm smoke-guacd || true

  ###########################################
  # JOB 3 — Build Guacamole Web (Tomcat)
  ###########################################
  build-guacamole:
    runs-on: ubuntu-latest
    needs: build-guacd
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes in guacamole-tomcat
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^guacamole-tomcat/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Show result
        run: |
          echo "Changes detected: ${{ steps.changes.outputs.changes }}"

      - name: Setup Docker Buildx
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (only on main)
        if: ${{ steps.changes.outputs.changes == 'true' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build guacamole image (push only on main)
        if: ${{ steps.changes.outputs.changes == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: ./guacamole-tomcat
          file: ./guacamole-tomcat/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ghcr.io/${{ github.actor }}/guacamole:latest

      - run: docker images
